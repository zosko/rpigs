<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/OpenLayers.js"></script>
	<title>Ground Station</title>
</head>
<body>
<div class="ports-wrapper">
	<select id="ports"></select><br /><br /><br />
	<div id="connect"><img src="images/power_on.png" width="80"></div>
</div>
<div class="container hide">
	<div id="map"></div>
	<div class="top-center">
		<div class="box">
			<label>LATITUDE</label>
			<div id="lat">~</div>
		</div>
		<div class="box">
			<label>SATS</label>
			<div id="gps_sats">~</div>
		</div>
		<div class="box">
			<label>LONGITUDE</label>
			<div id="lng">~</div>
		</div>
	</div>

	<div class="top-left">
		<div class="box">
			<label>CURRENT</label>
			<div id="current">~</div>
		</div>
		<div class="box">
			<label>VOLTAGE</label>
			<div id="voltage">~</div>
		</div>
		<div class="box">
			<label>SPEED</label>
			<div id="speed">~</div>
		</div>
		<div class="box">
			<label>ALTITUDE</label>
			<div id="alt">~</div>
		</div>
		<div class="box">
			<label>DISTANCE</label>
			<div id="distance">~</div>
		</div>
	</div>

	<div class="top-right">
		<div class="box">
			<label>FLIGHT MODE</label>
			<div id="stabilization">~</div>
		</div>
		<div class="box">
			<label>ARMED</label>
			<div id="arm">~</div>
		</div>
		<div class="box">
			<label>FUEL</label>
			<div id="fuel">~</div>
		</div>
		<div class="box">
			<label>SIGNAL</label>
			<div id="rssi">~</div>
		</div>
		<div class="box">
			<label>LAST PACKET</label>
			<div id="lastPacket">~</div>
		</div>
	</div>

	<div class="bottom-right">
		<span class="img-wrapper" id="disconnect"><img src="images/power_off.png" width="80"></span>
		<span class="img-wrapper">
			<img src="images/compass.png" width="150">
			<img id="heading" class="img-overlap" src="images/compass_plane.png" width="150">
		</span>
		<span class="img-wrapper">
			<img src="images/attitude-indicator-bg.png" width="150">
			<img id="attitude-horizont" class="img-overlap" src="images/attitude-horizont.png" width="150">
			<img id="attitude-plane" class="img-overlap" src="images/horizon_plane.png" width="150">
		</span>		
	</div>

	<div class="bottom-left">
		<div class="box">
			<label id="fake_north" class="vertical-center">FAKE NORTH</label>
		</div>
		<div class="box">
			<label id="follow" class="vertical-center">FREE MAP</label>
		</div>
	</div>
</div>
<script>
	$(document).ready(function() {
		map = new OpenLayers.Map("map", {
            controls: [
                new OpenLayers.Control.ZoomPanel(),
                new OpenLayers.Control.Navigation()
            ]
        });

        map.addLayer(new OpenLayers.Layer.OSM("Local Tiles", "tiles/${z}/${x}/${y}.png"));
      	epsg4326 =  new OpenLayers.Projection("EPSG:4326");
      	projectTo = map.getProjectionObject();
      	var markers = new OpenLayers.Layer.Markers("Markers");
      	var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
      	var zoom = 16;
		var planeMarker = null;
		var homeMarker = null;

		setInterval(function(){ 
			$.get("/flight", function(data, status) {
				var jsonData = JSON.parse(data);
          		$('#lat').text(jsonData.plane.lat);
          		$('#lng').text(jsonData.plane.lng);
          		$('#alt').text(jsonData.alt+"m");
          		$('#gps_sats').text(jsonData.gps_sats);
          		$('#distance').text(jsonData.distance+"m");
          		$('#speed').text(jsonData.speed+"km/h");
          		$('#voltage').text(jsonData.voltage+"v");
          		$('#rssi').text(jsonData.rssi+"%");
          		$('#current').text(jsonData.current+"a");
          		$('#arm').text(jsonData.arm);
          		$('#stabilization').text(jsonData.stabilization);
          		$('#fuel').text(jsonData.fuel+"%");

          		$("#heading").css({'transform': 'rotate('+jsonData.heading+'deg)'});
          		$("#attitude-horizont").css({top:-jsonData.pitch});
				$("#attitude-plane").css({'transform': 'rotate('+jsonData.roll+'deg)'});
				$('#lastPacket').text(jsonData.last_packet + "s");

				if (planeMarker != null){
					markers.removeMarker(planeMarker);
				}

				if (homeMarker == null){
					if (jsonData.home.lng != 0 && jsonData.home.lat != 0){
						var lonLat = new OpenLayers.LonLat( jsonData.home.lng,jsonData.home.lat).transform(epsg4326, projectTo);
						homeMarker = new OpenLayers.Marker(lonLat);
    					markers.addMarker(homeMarker);
    					map.addLayer(markers);	
					}
				}
				
				var lonLat = new OpenLayers.LonLat( jsonData.plane.lng,jsonData.plane.lat ).transform(epsg4326, projectTo);
				planeMarker = new OpenLayers.Marker(lonLat);
    			markers.addMarker(planeMarker);
    			map.addLayer(markers);

    			if ($('#follow').text() === "FREE MAP"){
					map.setCenter (lonLat, zoom);
    			}

    			if (!$('#fake_north').parent().is(":visible")) {
    				$.get("/tracker", function(data, status) {
    					console.log(data);
		        	});
    			}
        	});
		}, 300);

		$.get("/ports", function(data, status) {
          var jsonData = JSON.parse(data);
          	$(jsonData).each(function(index,element) {
        		$("#ports").append($("<option />").val(element.path).text(element.path));
    		});
        });
        $('#disconnect').on('click', function() {
	        $.get("/disconnect", function(data, status) {
          		$('.container').addClass('hide');
        		$('.ports-wrapper').removeClass('hide');
        		$('#fake_north').parent().show();
        		homeMarker = null;
        		planeMarker = null;
        	});
	    });
	    $('#follow').on('click', function() {
	        $(this).text($(this).text()==="FOLLOW MAP" ? "FREE MAP" : "FOLLOW MAP");
	    });
	    $('#fake_north').on('click', function() {
	        $.get("/fake_north", function(data, status) {
          		$('#fake_north').parent().hide();
        	});
	    });
        $('#connect').on('click', function() {
        	var selectedPort = $("#ports option:selected").text();
	        $.post("/connect/",{port:selectedPort}, function(data, status) {
          		$('.container').removeClass('hide');
        		$('.ports-wrapper').addClass('hide');
        	});
	    });
	});
</script>
<link rel="stylesheet" href="css/style.css">
</body>
</html>